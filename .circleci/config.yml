version: 2

workflows:
  version: 2
  tag:
    jobs:
      - build:
          filters:
            branches:
              ignore: /.*/
            tags: # Only work with git tags that are formatted like 'v0.0.1'.
              only: /(^[Vv]|^)(?:(?<major>(?:0|[1-9](?:(?:0|[1-9])+)*))[.](?<minor>(?:0|[1-9](?:(?:0|[1-9])+)*))[.](?<patch>(?:0|[1-9](?:(?:0|[1-9])+)*))(?:-(?<prerelease>(?:(?:(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?|(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?)|(?:0|[1-9](?:(?:0|[1-9])+)*))(?:[.](?:(?:(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?|(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?)|(?:0|[1-9](?:(?:0|[1-9])+)*)))*))?(?:[+](?<build>(?:(?:(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?|(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?)|(?:(?:0|[1-9])+))(?:[.](?:(?:(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?|(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)(?:[A-Za-z]|-)(?:(?:(?:0|[1-9])|(?:[A-Za-z]|-))+)?)|(?:(?:0|[1-9])+)))*))?)$/

jobs:
  build:
    machine: true
    working_directory: ~/aete
    steps:
      - checkout
      - run:
          name: Install buildx
          command: |
            export DOCKER_CLI_EXPERIMENTAL=enabled
            wget https://github.com/docker/buildx/releases/download/v0.5.1/buildx-v0.5.1.linux-amd64
            mkdir -p ~/.docker/cli-plugins
            mv buildx-v0.5.1.linux-amd64 ~/.docker/cli-plugins/docker-buildx
            chmod +x ~/.docker/cli-plugins/docker-buildx
            ~/.docker/cli-plugins/docker-buildx
      - run:
          name: Create a multi-architecture build instance
          command: |
            ~/.docker/cli-plugins/docker-buildx create --name mybuilder
            ~/.docker/cli-plugins/docker-buildx use mybuilder
            ~/.docker/cli-plugins/docker-buildx inspect --bootstrap
      - run:
          name: Build and publish AETE image to docker hub
          command: |
            ~/.docker/cli-plugins/docker-buildx build --platform linux/arm,linux/arm64,linux/amd64 -t changjoon/aete:${CIRCLE_TAG} . --push
            ~/.docker/cli-plugins/docker-buildx imagetools inspect changjoon/aete:${CIRCLE_TAG}
